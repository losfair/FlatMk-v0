# FlatMk Capability API Specification

*This file is automatically generated.*

## Enums

- `BasicTaskRequest`

A request to a BasicTask/BasicTaskWeak endpoint.

| Variant | Index |
| ------- | ----- |
| Ping | 0 |
| FetchShallowClone | 1 |
| FetchCapSet | 2 |
| FetchRootPageTable | 3 |
| FetchWeak | 4 |
| FetchTaskEndpoint | 5 |
| FetchIpcCap | 6 |
| PutIpcCap | 7 |
| PutCapSet | 8 |
| PutRootPageTable | 9 |
| MakeCapSet | 10 |
| MakeRootPageTable | 11 |
| SetRegister | 12 |
| HasWeak | 13 |
| IpcReturn | 14 |
| PutFaultHandler | 15 |
| GetAllRegisters | 16 |
| SetAllRegisters | 17 |
| SetSyscallDelegated | 18 |

- `BootParameterKey`

A key to a boot parameter.

| Variant | Index |
| ------- | ----- |
| FramebufferInfo | 0 |

- `CapSetRequest`

A request to a capability set.

| Variant | Index |
| ------- | ----- |
| MakeLeafSet | 0 |
| CloneCap | 1 |
| DropCap | 2 |
| FetchCap | 3 |
| PutCap | 4 |
| MoveCap | 6 |
| GetCapType | 7 |
| FetchCapMove | 8 |
| PutCapMove | 9 |

- `CapType`

The type of a capability endpoint.

| Variant | Index |
| ------- | ----- |
| Other | 0 |
| TaskEndpoint | 1 |
| RootPageTable | 2 |

- `InterruptRequest`

A request to an interrupt endpoint.

| Variant | Index |
| ------- | ----- |
| Bind | 0 |
| Unbind | 1 |

- `IpcRequest`

A request to an IPC endpoint for another task.

| Variant | Index |
| ------- | ----- |
| SwitchTo | 0 |
| IsCapTransfer | 1 |
| IsTaggable | 2 |
| IsReply | 3 |
| SetTag | 4 |
| GetTag | 5 |
| Ping | 6 |

- `KernelError`

Kernel error codes.

| Variant | Index |
| ------- | ----- |
| OutOfMemory | -8 |
| InvalidReference | -7 |
| EmptyCapability | -6 |
| EmptyObject | -5 |
| InvalidAddress | -4 |
| InvalidState | -3 |
| NotImplemented | -2 |
| InvalidArgument | -1 |

- `RootPageTableRequest`

A request to a root page table.

| Variant | Index |
| ------- | ----- |
| MakeLeaf | 0 |
| AllocLeaf | 1 |
| PutPage | 2 |
| FetchPage | 3 |
| DropPage | 4 |
| SetProtection | 5 |

- `RootTaskCapRequest`

A request to the root capability.

| Variant | Index |
| ------- | ----- |
| X86IoPort | 0 |
| Mmio | 1 |
| MakeIdle | 2 |
| Interrupt | 3 |
| DebugPutchar | 4 |
| GetBootParameter | 5 |

- `TaskFaultReason`

Reason of a fault from a user-mode task.

| Variant | Index |
| ------- | ----- |
| VMAccess | 0 |
| IllegalInstruction | 1 |
| InvalidCapability | 2 |
| InvalidOperation | 3 |

- `TrivialSyscall`

A trivial syscall that is not invoked on a capability.

| Variant | Index |
| ------- | ----- |
| SchedYield | 0 |
| SchedDrop | 1 |
| SchedNanosleep | 2 |
| SchedSubmit | 3 |
| SoftuserEnter | 4 |
| SoftuserLeave | 5 |

- `X86IoPortRequest`

A request to an X86 I/O port.

| Variant | Index |
| ------- | ----- |
| Read | 0 |
| Write | 1 |

## Bitflags

- `TaskEndpointFlags`

Flags for a task endpoint.

| Flag | Bit |
| ------- | ----- |
| CAP_TRANSFER | 0 |
| TAGGABLE | 1 |

- `UserPteFlags`

Flags for a user page table entry.

| Flag | Bit |
| ------- | ----- |
| WRITABLE | 0 |
| EXECUTABLE | 1 |

## Types

### BasicTask

A strong or weak reference to a task.

- `call_invalid`

Invokes an invalid operation on this capability. Useful for benchmarking.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `fetch_capset`

Fetch the capability set of this task into the current task's capability set.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `fetch_ipc_cap`

Fetches a capability from the IPC capability buffer of this task. The capability is moved instead of cloned.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |
| index | u64 | An index to the capability buffer. |

- `fetch_root_page_table`

Fetch the root page table of this task into the current task's capability set.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `fetch_shallow_clone`

Makes a shallow clone for this task. The clone will always be a strong reference.

The resulting task shares the same capability set and page table with this task, but has its own state flags and execution context.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `fetch_task_endpoint`

Fetches an IPC endpoint to this task.

The first argument `mixed_arg1` is a mixed argument that contains several properties:

- Bits 0 to 47 (inclusively) is a capability pointer in the current task's capability set to write to.
- Bits 48 to 62 is a bitflag set of type `TaskEndpointFlags`.
- Bit 63 indicates whether the new endpoint is a reply endpoint.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| mixed_arg1 | u64 | The mixed argument. |
| pc | u64 | Program Counter/Instruction Pointer value for the IPC entry. |
| user_context | u64 | User context for the IPC entry. |

- `fetch_weak`

Makes a weak reference for this task.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `get_all_registers`

Gets all registers of this task.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| ptr | u64 | Pointer to write to. |
| len | u64 | Length of the memory `ptr` points to. |

- `has_weak`

Returns whether there exists weak references to this task.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `ipc_return`

Fast path for returning from an IPC call, by automatically invoking the 0th entry in this task's IPC capability buffer.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `make_capset`

Makes a capability set and puts its endpoint in the current task's capability set. (FIXME: Maybe this shouldn't be in BasicTask?)

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `make_root_page_table`

Makes a root page table and puts its endpoint in the current task's capability set. (FIXME: Maybe this shouldn't be in BasicTask?)

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `ping`

Detects whether the reference is still alive if it is a weak reference. Always return 0 for strong references.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `put_capset`

Puts an endpoint to a capability set in the current task's capability set into this task's capability set.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| cptr | Type: CapabilitySet | A capability pointer in the current task's capability set to read from. |

- `put_fault_handler`

Sets the fault handler of this task.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| handler | Type: TaskEndpoint | The endpoint to the handler. Must have a `Call` entry type. |

- `put_ipc_cap`

Puts a capability into the IPC capability buffer of this task. The capability is moved instead of cloned.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| cptr | CPtr | A capability pointer in the current task's capability set to read from. |
| index | u64 | An index to the capability buffer. |

- `put_root_page_table`

Puts an endpoint to a root page table in the current task's capability set into this task's capability set.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| cptr | Type: RootPageTable | A capability pointer in the current task's capability set to read from. |

- `set_all_registers`

Sets all registers of this task.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| ptr | u64 | Pointer to read from. |
| len | u64 | Length of the memory `ptr` points to. |

- `set_register`

Sets a saved register of this task. Calling this method on a running task has undefined result.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| index | u64 | The DWARF index for the target register. |
| value | u64 | The value to set the register to. |

- `set_syscall_delegated`

Sets the syscall delegation status of this task.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| status | u64 | A boolean value indicating whether to enable syscall delegation. |

### CapabilitySet

A capability set.

- `clone_cap`

Clones a capability.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | CPtr | Source capability pointer. |
| dst | CPtr | Destination capability pointer. |

- `drop_cap`

Drops a capability.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| cptr | CPtr | The capability pointer that points to the target capability. |

- `fetch_cap`

Fetches a capability from this capability set to the current task's capability set.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | CPtr | Source capability pointer. |
| dst | CPtr | Destination capability pointer. |

- `fetch_cap_move`

Fetches a capability from this capability set to the current task's capability set, with moving semantics.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | CPtr | Source capability pointer. |
| dst | CPtr | Destination capability pointer. |

- `get_cap_type`

Returns the type of the capability. The return type is actually `CapType` but needs a conversion.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| cptr | CPtr | The capability pointer that points to the target capability. |

- `make_leaf`

Makes a leaf entry in this capability set, and initializes it with empty capabilities.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| cptr | CPtr | The "base" capability pointer that points to the entry. |

- `put_cap`

Puts a capability from the current task's capability set to this capability set.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | CPtr | Source capability pointer. |
| dst | CPtr | Destination capability pointer. |

- `put_cap_move`

Puts a capability from the current task's capability set to this capability set, with moving semantics.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | CPtr | Source capability pointer. |
| dst | CPtr | Destination capability pointer. |

### DebugPutchar

Debugging utility used during early init to print a character to the serial port.

- `putchar`

Prints a character to the serial port.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| value | u64 | The 8-bit character to print. |

### Interrupt

Capability to an interrupt.

- `bind`

Binds the interrupt to a task.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| task | Type: BasicTask | The task to bind to. |
| pc | u64 | Program Counter/Instruction Pointer value for the IPC entry. |
| user_context | u64 | User context for the IPC entry. |

### Mmio

Memory-mapped I/O on one memory page.

- `alloc_at`

Map the backing physical page into this endpoint's associated page table.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| vaddr | u64 | The target virtual address. |
| prot | Bitflags: UserPteFlags | Protection flags. |

### RootPageTable

Capability to a root page table.

- `alloc_leaf`

Allocates a page at a leaf entry in this root page table. Will also create the leaf entry if not exists.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| vaddr | u64 |  |
| prot | Bitflags: UserPteFlags |  |

- `drop_page`

Drops a page.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| target | u64 |  |

- `fetch_page`

Clones reference to a page in this page table to the current task's page table. Will also create the leaf entry if not exists.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | u64 |  |
| dst | u64 |  |
| prot | Bitflags: UserPteFlags |  |

- `make_leaf`

Creates a leaf entry in this root page table, without allocating page for it.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| vaddr | u64 |  |

- `put_page`

Clones reference to a page in the current task's page table to this page table. Will also create the leaf entry if not exists.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| src | u64 |  |
| dst | u64 |  |
| prot | Bitflags: UserPteFlags |  |

- `set_protection`

Sets protection flags for a page table entry.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| target | u64 |  |
| prot | Bitflags: UserPteFlags |  |

### RootTask

The "privileged" root task capability. Hardware capabilities are derived from this.

- `get_boot_parameter`

Reads the boot parameter of key `key`. Returns 0 on succeed, negative error code on failure.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| key | i64 | The key to the requested parameter. Is of type `BootParameterKey`. |
| out | u64 | Output address. |
| out_len | u64 | Length of the memory block `out` points to. |

- `make_idle`

Make the current task an idle task. Never returns if succeeded.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `new_debug_putchar`

Creates a `DebugPutchar` endpoint.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |

- `new_interrupt`

Creates an `Interrupt` endpoint for an interrupt index.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |
| index | u64 | The associated interrupt index. |

- `new_mmio`

Creates an `Mmio` endpoint for the physical page starting at `phys_addr`.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |
| page_table | Type: RootPageTable | The page table that the physical page will be mapped into. |
| phys_addr | u64 | The physical address. |

- `new_x86_io_port`

Creates an `X86IoPort` endpoint for a hardware I/O port.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| out | CPtr | A capability pointer in the current task's capability set to write to. |
| port | u64 | The associated port. |

### TaskEndpoint

An IPC endpoint.

- `get_tag`

Gets a source-specific tag on the backing task of this IPC endpoint.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `invoke`

Invokes the IPC endpoint.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `is_cap_transfer`

Checks whether this task endpoint has the `CAP_TRANSFER` flag set.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `is_reply`

Checks whether this is a reply endpoint.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `is_taggable`

Checks whether this task endpoint has the `TAGGABLE` flag set.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `ping`

Checks whether the backing task is still alive.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `set_tag`

Sets a source-specific tag on the backing task of this IPC endpoint. Requires the `TAGGABLE` flag.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| tag | u64 | The value of the new tag. |

### TrivialSyscallEntry

Entry to trivial syscalls. Only valid on capability pointer `u64::MAX`.

- `sched_drop`

Drops the current task from the scheduler.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `sched_nanosleep`

Put the current task to sleep.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| duration | u64 | Duration in nanoseconds. |

- `sched_submit`

Submits a scheduling endpoint.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| target | Type: TaskEndpoint | Reply endpoint to submit. |

- `sched_yield`

Yields from the current task to allow other tasks to run.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `softuser_enter`

Enters softuser mode.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| pc | u64 | Program counter value to start execution from. |

- `softuser_leave`

Leaves softuser mode.

| Argument | Kind | Description
| -------- | ---- | ----------- |

### X86IoPort

Capability to an X86 I/O port.

- `inb`

Calls the x86 `inb` instruction on this port.

| Argument | Kind | Description
| -------- | ---- | ----------- |

- `outb`

Calls the x86 `outb` instruction on this port.

| Argument | Kind | Description
| -------- | ---- | ----------- |
| value | u64 | The 8-bit value to write. |

